## 목차
---

# 3장. 워터마크
##### 스트림 처리 시스템의 기본 메커니즘의 관점에서의 워터마크
- 데이터 인입 시점에서 워터마크가 어떻게 생성되는지
- 생성된 워터마크가 데이터 처리 파이프라인을 통해 어떻게 전파되는지
- 출력 타임스탬프는 어떤 영향을 주는지

## 정의
데이터를 수집하며 결과를 지속적으로 출력하는 파이프라인에서 언제 이벤트 시간 윈도우를 닫아도 안전할까? 이 파이프라인은 무한한 입력을 처리하고 있다고 가정한다.
- 이벤트 시간 윈도우를 현재 처리 시간 기반으로 한다.
  - 처리 시간과 이벤트 시간은 같을 수 없기 때문에 실제 시간을 반영하지 않는다. > 올바른 이벤트 시간 윈도우로 할당되지 않는다.
- 파이프라인의 메시지 처리 속도를 고려해 반영한다.
  - 진행 정도만으로는 완결성 여부를 판단할 수 없다.

따라서 진행정도를 측정하기 위한 더 강력한 방법(=워터마크)이 필요하다. 

##### 타임스탬프
스트림 처리에서 이벤트 시간을 지원하기 위해 레코드 타임스탬프가 필요하다. 따라서 각 데이터는 논리적인 이벤트 시간 타임스탬프를 포함하고 있다고 가정한다. 대부분의 경우 실제 이벤트의 발생 시점을 논리적인 이벤트 시간 타임스탬프로 다룰 수 있다. 이벤트 시간을 포함하는 데이터를 통해 파이프라인 내에서 이벤트 시간 타임스탬프의 분포를 확인할 수 있다.

파이프라인은 여러 기기를 통해 병렬로 입력 데이터를 소비할 것이고, 개별 기기 간 순서에 대한 보장은 없다. 따라서 데이터 파이프라인에서 처리 중인 데이터 이벤트 시간의 분포를 확인하면 다음과 같은 모양이 될 것이다.

![stsy_0301](https://user-images.githubusercontent.com/19989706/154208504-9926f988-a471-4f8e-902c-79aa2b00da4b.gif)

파이프라인은 데이터를 입력받아 처리하고 나중에 완료된 것으로 표시할 것이다. 각 데이터는 처리 중(in-flight) 상태이거나, 완료(completed) 상태에 놓인다.
- 처리 중(in-flight): 데이터를 받았지만 아직 처리가 완료되지 않은 상태
- 완료(completed): 데이터에 대한 처리가 더 이상 필요하지 않은 상태

핵심은 파이프라인에서 처리되지 않은 데이터 중 가장 오래된 이벤트 시간에 해당하는 처리 중 부분의 가장 왼쪽 끝이다. 워터마크 정의에는 이 값을 사용한다.

##### 워터마크 정의
- 워터마크: 워터마크는 아직 완료되지 않는 가장 오래된 작업이 갖는 단조 증가(monotonically increasing) 타임스탬프이다.

이 정의에 의해 제공되는 두 가지 근본적인 특성을 알아보자.
- 완결성 (completeness)
  - 워터마크가 어떤 타임스탬프 T를 지난 경우, 단조라는 속성으로 인해 T를 기준으로 그 전에 발생한 이벤트는 만나지 않음을 보장한다.
  - 워터마크를 사용하면 윈도우를 닫을 수 있는 시점을 알 수 있다.
- 가시성 (visibility)
  - 메시지가 파이프라인 내에서 처리되지 않고 있으면, 워터마크가 진행되지 않는다.

## 소스 워터마크 생성

### 완벽한 워터마크 생성
완벽한 워터마크를 생성하려면 워터마크가 그보다 작은 이벤트 시간을 갖는 데이터가 입력으로 들어오지 않도록 엄격하게 보장해주는 방식으로 입력 데이터에 타임스탬프를 할당해야 한다.

#### 인입 타임스탬프(ingress timestamp)
시스템에 입력되는 데이터의 인입 시간을 이벤트 시간으로 설정한다.

#### 시간순으로 정렬된 정적 로그 데이터(Static sets of time-ordered logs)
아파치 카프카 토픽처럼, 각 파티션에 단조 증가하는 이벤트 시간이 포함돼 있는 정적 분할에 속하는 정적인 크기를 갖는 시간순 로그 데이터는 완벽한 워터마크를 생성할 수 있다.

![](https://nightlies.apache.org/flink/flink-docs-master/fig/stream_watermark_in_order.svg)

### 휴리스틱 워터마크 생성

## 워터마크 전파

# Reference
- Flink Documentation: https://nightlies.apache.org/flink/flink-docs-master/docs/concepts/time/
